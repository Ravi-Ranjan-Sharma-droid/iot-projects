<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Rover Control</title>
    <style>
        /* Global Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        body {
            background-color: #121212;
            color: #ffffff;
            overflow: hidden;
            touch-action: manipulation;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        header {
            text-align: center;
            padding: 10px 0;
            background-color: #1e1e1e;
            border-bottom: 2px solid #3498db;
            position: relative;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 5px;
            color: #3498db;
        }
        
        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            background-color: #1e1e1e;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-connected {
            background-color: #2ecc71;
        }
        
        .status-disconnected {
            background-color: #e74c3c;
        }
        
        /* Control Sections */
        .control-section {
            background-color: #1e1e1e;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #3498db;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
        }
        
        /* Movement Controls */
        .movement-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            max-width: 300px;
            margin: 0 auto;
        }
        
        .control-btn {
            background-color: #2c2c2c;
            border: none;
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            font-size: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .control-btn:active {
            background-color: #3498db;
            transform: scale(0.95);
        }
        
        .control-btn.active {
            background-color: #3498db;
        }
        
        .control-btn i {
            font-size: 24px;
        }
        
        /* Center the forward, backward, and stop buttons */
        .btn-forward {
            grid-column: 2;
            grid-row: 1;
        }
        
        .btn-left {
            grid-column: 1;
            grid-row: 2;
        }
        
        .btn-stop {
            grid-column: 2;
            grid-row: 2;
            background-color: #e74c3c;
        }
        
        .btn-stop:active {
            background-color: #c0392b;
        }
        
        .btn-right {
            grid-column: 3;
            grid-row: 2;
        }
        
        .btn-backward {
            grid-column: 2;
            grid-row: 3;
        }
        
        /* Speed Control */
        .speed-control {
            margin-top: 20px;
            text-align: center;
        }
        
        .speed-slider {
            width: 100%;
            margin: 10px 0;
            -webkit-appearance: none;
            height: 15px;
            border-radius: 10px;
            background: #2c2c2c;
            outline: none;
        }
        
        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
        
        .speed-slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
        }
        
        .speed-value {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
        }
        
        /* Light Controls */
        .light-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .light-btn {
            background-color: #2c2c2c;
            border: none;
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .light-btn i {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .light-btn.active {
            background-color: #f39c12;
        }
        
        /* Special Controls */
        .special-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .special-btn {
            background-color: #2c2c2c;
            border: none;
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 16px;
        }
        
        .special-btn:active {
            background-color: #9b59b6;
        }
        
        /* Horn Button */
        .horn-btn {
            background-color: #e67e22;
            grid-column: span 2;
            margin-top: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .horn-btn i {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .horn-btn:active {
            background-color: #d35400;
        }
        
        /* Telemetry Section */
        .telemetry {
            background-color: #1e1e1e;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .telemetry-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .telemetry-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #2c2c2c;
        }
        
        .telemetry-value {
            font-weight: bold;
            color: #3498db;
        }
        
        /* Joystick Control (Optional) */
        .joystick-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 20px auto;
            background-color: #2c2c2c;
            border-radius: 50%;
            border: 2px solid #3498db;
        }
        
        .joystick-knob {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background-color: #3498db;
            border-radius: 50%;
            cursor: grab;
        }
        
        .joystick-knob:active {
            cursor: grabbing;
        }
        
        /* Responsive Design */
        @media (min-width: 768px) {
            .controls-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            
            .movement-section {
                grid-column: 1;
            }
            
            .lights-section {
                grid-column: 2;
            }
            
            .special-section {
                grid-column: span 2;
            }
        }
        
        /* Connection Lost Overlay */
        .connection-lost {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .connection-lost-content {
            background-color: #e74c3c;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
        }
        
        .connection-lost h2 {
            margin-bottom: 20px;
        }
        
        .reconnect-btn {
            background-color: #ffffff;
            color: #e74c3c;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <h1>Smart Rover Control</h1>
        <p>ESP8266 Wi-Fi Controller</p>
    </header>
    
    <div class="container">
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator status-connected" id="connection-status"></div>
                <span id="connection-text">Connected</span>
            </div>
            <div class="status-item" id="uptime">Uptime: 00:00:00</div>
            <div class="status-item" id="last-command">Last: None</div>
        </div>
        
        <div class="controls-container">
            <!-- Movement Controls -->
            <div class="control-section movement-section">
                <div class="section-title">
                    <i class="fas fa-gamepad"></i> Movement Controls
                </div>
                
                <div class="movement-controls">
                    <button class="control-btn btn-forward" id="btn-forward">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button class="control-btn btn-left" id="btn-left">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <button class="control-btn btn-stop" id="btn-stop">
                        <i class="fas fa-stop"></i>
                    </button>
                    <button class="control-btn btn-right" id="btn-right">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <button class="control-btn btn-backward" id="btn-backward">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                </div>
                
                <div class="speed-control">
                    <label for="speed-slider">Speed Control</label>
                    <input type="range" min="300" max="1023" value="800" class="speed-slider" id="speed-slider">
                    <div class="speed-value" id="speed-value">Speed: 800</div>
                </div>
            </div>
            
            <!-- Light Controls -->
            <div class="control-section lights-section">
                <div class="section-title">
                    <i class="fas fa-lightbulb"></i> Light Controls
                </div>
                
                <div class="light-controls">
                    <button class="light-btn" id="btn-headlights">
                        <i class="fas fa-car-beam"></i>
                        Headlights
                    </button>
                    <button class="light-btn" id="btn-taillights">
                        <i class="fas fa-car"></i>
                        Taillights
                    </button>
                    <button class="light-btn" id="btn-left-indicator">
                        <i class="fas fa-arrow-left"></i>
                        Left Indicator
                    </button>
                    <button class="light-btn" id="btn-right-indicator">
                        <i class="fas fa-arrow-right"></i>
                        Right Indicator
                    </button>
                    <button class="light-btn" id="btn-hazard">
                        <i class="fas fa-exclamation-triangle"></i>
                        Hazard Lights
                    </button>
                    <button class="light-btn horn-btn" id="btn-horn">
                        <i class="fas fa-bullhorn"></i>
                        Horn
                    </button>
                </div>
            </div>
            
            <!-- Special Controls -->
            <div class="control-section special-section">
                <div class="section-title">
                    <i class="fas fa-star"></i> Special Effects
                </div>
                
                <div class="special-controls">
                    <button class="special-btn" id="btn-police">
                        Police Lights
                    </button>
                    <button class="special-btn" id="btn-knight-rider">
                        Knight Rider
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Telemetry Section -->
        <div class="telemetry">
            <div class="section-title">
                <i class="fas fa-chart-line"></i> Telemetry
            </div>
            
            <div class="telemetry-grid">
                <div class="telemetry-item">
                    <span>Connection Status:</span>
                    <span class="telemetry-value" id="telemetry-connection">Connected</span>
                </div>
                <div class="telemetry-item">
                    <span>Motor Status:</span>
                    <span class="telemetry-value" id="telemetry-motors">Stopped</span>
                </div>
                <div class="telemetry-item">
                    <span>Current Speed:</span>
                    <span class="telemetry-value" id="telemetry-speed">800</span>
                </div>
                <div class="telemetry-item">
                    <span>Last Command:</span>
                    <span class="telemetry-value" id="telemetry-command">None</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Connection Lost Overlay -->
    <div class="connection-lost" id="connection-lost">
        <div class="connection-lost-content">
            <h2>Connection Lost</h2>
            <p>The connection to the Smart Rover has been lost.</p>
            <p>The rover has automatically stopped for safety.</p>
            <button class="reconnect-btn" id="reconnect-btn">Reconnect</button>
        </div>
    </div>
    
    <script>
        // DOM Elements
        const connectionStatus = document.getElementById('connection-status');
        const connectionText = document.getElementById('connection-text');
        const uptimeElement = document.getElementById('uptime');
        const lastCommandElement = document.getElementById('last-command');
        const speedSlider = document.getElementById('speed-slider');
        const speedValue = document.getElementById('speed-value');
        const connectionLostOverlay = document.getElementById('connection-lost');
        const reconnectBtn = document.getElementById('reconnect-btn');
        
        // Telemetry elements
        const telemetryConnection = document.getElementById('telemetry-connection');
        const telemetryMotors = document.getElementById('telemetry-motors');
        const telemetrySpeed = document.getElementById('telemetry-speed');
        const telemetryCommand = document.getElementById('telemetry-command');
        
        // Movement buttons
        const btnForward = document.getElementById('btn-forward');
        const btnBackward = document.getElementById('btn-backward');
        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');
        const btnStop = document.getElementById('btn-stop');
        
        // Light buttons
        const btnHeadlights = document.getElementById('btn-headlights');
        const btnTaillights = document.getElementById('btn-taillights');
        const btnLeftIndicator = document.getElementById('btn-left-indicator');
        const btnRightIndicator = document.getElementById('btn-right-indicator');
        const btnHazard = document.getElementById('btn-hazard');
        const btnHorn = document.getElementById('btn-horn');
        
        // Special buttons
        const btnPolice = document.getElementById('btn-police');
        const btnKnightRider = document.getElementById('btn-knight-rider');
        
        // State tracking
        let isConnected = true;
        let activeMovement = null;
        let activeLights = {
            headlights: false,
            taillights: false,
            leftIndicator: false,
            rightIndicator: false,
            hazard: false,
            horn: false
        };
        
        // API endpoint
        const apiBase = '/api/';
        
        // Initialize
        function init() {
            // Set initial speed
            updateSpeed(speedSlider.value);
            
            // Setup event listeners
            setupEventListeners();
            
            // Start status updates
            startStatusUpdates();
            
            // Start heartbeat
            startHeartbeat();
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Speed slider
            speedSlider.addEventListener('input', function() {
                updateSpeed(this.value);
            });
            
            // Movement buttons - touch events for mobile
            setupMovementButton(btnForward, 'forward');
            setupMovementButton(btnBackward, 'backward');
            setupMovementButton(btnLeft, 'left');
            setupMovementButton(btnRight, 'right');
            setupMovementButton(btnStop, 'stop');
            
            // Light toggle buttons
            setupLightToggle(btnHeadlights, 'headlights');
            setupLightToggle(btnTaillights, 'taillights');
            setupLightToggle(btnLeftIndicator, 'left_indicator');
            setupLightToggle(btnRightIndicator, 'right_indicator');
            setupLightToggle(btnHazard, 'hazard');
            
            // Horn button (press and hold)
            btnHorn.addEventListener('mousedown', function() { sendCommand('horn/on'); });
            btnHorn.addEventListener('mouseup', function() { sendCommand('horn/off'); });
            btnHorn.addEventListener('touchstart', function(e) { 
                e.preventDefault(); 
                sendCommand('horn/on'); 
            });
            btnHorn.addEventListener('touchend', function() { sendCommand('horn/off'); });
            
            // Special effect buttons
            btnPolice.addEventListener('click', function() { sendCommand('light_pattern/police'); });
            btnKnightRider.addEventListener('click', function() { sendCommand('light_pattern/knight_rider'); });
            
            // Reconnect button
            reconnectBtn.addEventListener('click', attemptReconnect);
        }
        
        // Setup movement button with touch support
        function setupMovementButton(button, command) {
            // Mouse events
            button.addEventListener('mousedown', function() {
                sendCommand(command);
                setActiveMovement(command);
            });
            
            // Touch events
            button.addEventListener('touchstart', function(e) {
                e.preventDefault(); // Prevent scrolling when touching buttons
                sendCommand(command);
                setActiveMovement(command);
            });
        }
        
        // Setup light toggle button
        function setupLightToggle(button, command) {
            button.addEventListener('click', function() {
                const isActive = button.classList.contains('active');
                const state = isActive ? 'off' : 'on';
                sendCommand(`${command}/${state}`);
                button.classList.toggle('active');
                
                // Update state tracking
                const stateKey = command.replace('_', '');
                activeLights[stateKey] = !isActive;
            });
        }
        
        // Set active movement and update UI
        function setActiveMovement(command) {
            // Remove active class from all movement buttons
            btnForward.classList.remove('active');
            btnBackward.classList.remove('active');
            btnLeft.classList.remove('active');
            btnRight.classList.remove('active');
            btnStop.classList.remove('active');
            
            // Add active class to current command button
            if (command === 'forward') btnForward.classList.add('active');
            else if (command === 'backward') btnBackward.classList.add('active');
            else if (command === 'left') btnLeft.classList.add('active');
            else if (command === 'right') btnRight.classList.add('active');
            else if (command === 'stop') btnStop.classList.add('active');
            
            activeMovement = command;
            updateTelemetry('motors', command);
        }
        
        // Update speed
        function updateSpeed(speed) {
            speedValue.textContent = `Speed: ${speed}`;
            telemetrySpeed.textContent = speed;
            sendCommand(`speed/${speed}`);
        }
        
        // Send command to the rover
        function sendCommand(command) {
            if (!isConnected) return;
            
            fetch(`${apiBase}${command}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    console.log('Command result:', data);
                    updateLastCommand(command);
                    resetConnectionStatus();
                })
                .catch(error => {
                    console.error('Error sending command:', error);
                    handleConnectionError();
                });
        }
        
        // Update last command display
        function updateLastCommand(command) {
            lastCommandElement.textContent = `Last: ${command}`;
            telemetryCommand.textContent = command;
        }
        
        // Start periodic status updates
        function startStatusUpdates() {
            setInterval(() => {
                if (!isConnected) return;
                
                fetch(`${apiBase}status`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        updateStatus(data.result);
                        resetConnectionStatus();
                    })
                    .catch(error => {
                        console.error('Error fetching status:', error);
                        handleConnectionError();
                    });
            }, 1000); // Update every second
        }
        
        // Start heartbeat to keep connection alive
        function startHeartbeat() {
            setInterval(() => {
                if (!isConnected) return;
                
                fetch(`${apiBase}heartbeat`)
                    .catch(error => {
                        console.error('Heartbeat error:', error);
                        handleConnectionError();
                    });
            }, 2000); // Heartbeat every 2 seconds
        }
        
        // Update status display
        function updateStatus(status) {
            // Update uptime
            const uptime = formatUptime(status.uptime);
            uptimeElement.textContent = `Uptime: ${uptime}`;
            
            // Update telemetry
            updateTelemetry('connection', status.connection);
            updateTelemetry('motors', status.motors);
            updateTelemetry('command', status.last_command);
        }
        
        // Update telemetry item
        function updateTelemetry(key, value) {
            switch(key) {
                case 'connection':
                    telemetryConnection.textContent = value;
                    break;
                case 'motors':
                    telemetryMotors.textContent = value;
                    break;
                case 'command':
                    telemetryCommand.textContent = value;
                    break;
            }
        }
        
        // Format uptime as HH:MM:SS
        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return [
                hours.toString().padStart(2, '0'),
                minutes.toString().padStart(2, '0'),
                secs.toString().padStart(2, '0')
            ].join(':');
        }
        
        // Reset connection status indicators
        function resetConnectionStatus() {
            if (!isConnected) {
                isConnected = true;
                connectionStatus.classList.remove('status-disconnected');
                connectionStatus.classList.add('status-connected');
                connectionText.textContent = 'Connected';
                connectionLostOverlay.style.display = 'none';
            }
        }
        
        // Handle connection error
        function handleConnectionError() {
            if (isConnected) {
                isConnected = false;
                connectionStatus.classList.remove('status-connected');
                connectionStatus.classList.add('status-disconnected');
                connectionText.textContent = 'Disconnected';
                connectionLostOverlay.style.display = 'flex';
                
                // Reset active movement
                setActiveMovement('stop');
            }
        }
        
        // Attempt to reconnect
        function attemptReconnect() {
            fetch(`${apiBase}heartbeat`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    resetConnectionStatus();
                })
                .catch(error => {
                    console.error('Reconnect failed:', error);
                    // Keep showing disconnected state
                });
        }
        
        // Initialize on page load
        window.addEventListener('load', init);
        
        // Prevent scrolling on touch devices when interacting with controls
        document.addEventListener('touchmove', function(e) {
            if (e.target.closest('.control-btn, .light-btn, .special-btn, .horn-btn, .speed-slider')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>